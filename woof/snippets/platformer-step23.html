<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.rawgit.com/stevekrouse/WoofJS/d17fa61c/dist/woof.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Platformer Step 23</title>
</head>
<body>

<script>
setBackdropURL("../images/platformer-backdrop1.png");

var ground = new Rectangle({
  width: width,
  height: height / 5,
  color: "rgba(0, 0, 0, 0.7)",
  y: minY + height / 10
});
var groundLine = ground.y + ground.height / 2;

var obstacle1 = new Rectangle({
  color: "rgba(0, 0, 0, 0.7)",
  height: 100,
  width: 170,
  y: groundLine + 49,
  x: -100
});

var obstacle2 = new Rectangle({
  color: "rgba(0, 0, 0, 0.7)",
  height: 30,
  width: 100,
  y: groundLine + 85,
  x: maxX - 200
});

var obstacles = [obstacle1, obstacle2];

obstacles.forEach(obstacle => {
  obstacle.top = obstacle.y + obstacle.height / 2;
  obstacle.bottom = obstacle.y - obstacle.height / 2;
});

var player = new Image({
  height: 40,
  width: 40,
  url: "../images/platformer-player.png",
  x: minX + 30,
  y: groundLine + 200
});
player.setRotationStyle("ROTATE LEFT RIGHT");

var heartX = minX + 30;
var hearts = [];
for (var i = 0; i < 5; i++) {
  var heart = new Image({
    url: "../images/platformer-heart.png",
    height: 30,
    width: 30,
    x: heartX,
    y: maxY - 30
  });
  heartX += 30;
  hearts.push(heart);
}

var boss = new Image({
  url: "../images/platformer-boss.png",
  height: 100,
  width: 80,
  x: maxX + 50,
  y: groundLine + 50,
  showing: false
});
boss.speedX = -5;
boss.health = 50;

var bossHealth = new Text({
  text: () => "Boss Health: " + boss.health,
  x: maxX - 100,
  y: maxY - 30,
  size: 20,
  showing: false,
  color: "white",
  fontFamily: "arial black"
});

var fireballs = [];

var enemies = [];

var gameOver = false;

var gameOverText = new Image({
  url: "../images/platformer-game-over.png",
  y: 150,
  showing: false
});

var subLevel = 0;

var bossLevel = false;

forever(() => {
  gameOverText.showing = gameOver;
});

var speed = 0.35;

player.touchingSurface = () => {
  return player.y <= groundLine + 21 || obstacles.some(obstacle => player.touching(obstacle));
};

var removeHeart = () => {
  var heart = hearts.pop();
  heart.hide();
  player.brightness = 50;
  after(0.2, "second", () => {
    heart.show();
    player.brightness = 100;
    after(0.2, "second", () => {
      heart.hide();
      after(0.1, "second", () => {
        heart.show();
        after(0.1, "second", () => {
          heart.delete();
        });
      });
    });
  });
};

forever(() => {
  if (!gameOver) {
    if (keysDown.includes("right")) {
      player.angle = RIGHT;
      player.x += 10;
      obstacles.forEach(obstacle => {
        if (player.touching(obstacle) && player.y < obstacle.top + 20) {
          player.x -= 10;
        }
      });
    }
    if (keysDown.includes("left")) {
      player.angle = LEFT;
      player.x -= 10;
      obstacles.forEach(obstacle => {
        if (player.touching(obstacle) && player.y < obstacle.top + 20) {
          player.x += 10;
        }
      });
    }
    if (!player.touchingSurface()) {
      player.y -= speed;
      speed += 0.35;
    }
    else if (player.touching(ground)) {
      player.y = groundLine + 20;
      speed = 0.35;
    }
    else {
      obstacles.forEach(obstacle => {
        if (player.touching(obstacle) && player.y >= obstacle.top)
          player.y = obstacle.top + 20;
          speed = 0.35;
      });
    }
    if (player.x < minX)
      player.x = minX;
    if (player.x > maxX) {
      player.x = minX;
      enemies.forEach(enemy => {
        enemy.delete();
      });
      enemies = [];
      obstacles.forEach(obstacle => {
        obstacle.delete();
      });
      obstacles = [];
      if (subLevel === 0) {
        var obstacle1 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 100,
          width: 30,
          y: groundLine + 70,
          x: minX + 150
        });
        var obstacle2 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 60,
          width: 120,
          y: groundLine + 70,
          x: 100
        });
        var obstacle3 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 30,
          width: 100,
          y: groundLine + 55,
          x: 210
        });
        obstacles.push(obstacle1, obstacle2, obstacle3);
        obstacles.forEach(obstacle => {
          obstacle.top = obstacle.y + obstacle.height / 2;
          obstacle.bottom = obstacle.y - obstacle.height / 2;
        });
      }
      else if (subLevel === 1) {
        var obstacle1 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 70,
          width: 250,
          y: groundLine + 35,
          x: -140
        });
        var obstacle2 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 135,
          width: 30,
          y: groundLine + 67
        });
        var obstacle3 = new Rectangle({
          color: "rgba(0, 0, 0, 0.7)",
          height: 350,
          width: 300,
          y: groundLine + 250,
          x: maxX - 120
        });
        obstacles.push(obstacle1, obstacle2, obstacle3);
        obstacles.forEach(obstacle => {
          obstacle.top = obstacle.y + obstacle.height / 2;
          obstacle.bottom = obstacle.y - obstacle.height / 2;
        });
      }
      else if (subLevel === 2) {
        bossLevel = true;
        after(2, "second", () => {
          boss.show();
          bossHealth.show();
          repeat(10, () => {
            boss.move(-5);
          });
        });
      }
      subLevel++;
    }
  }
});

forever(() => {
  if (!gameOver) {
    fireballs.forEach(fireball => {
      fireball.move(fireball.speedX);
      fireball.y += fireball.speedY;
      fireball.speedY -= 0.35;
      if (fireball.x > maxX || fireball.y > maxY || fireball.x < minX || fireball.y < minY) {
        fireballs.remove(fireball);
        fireball.delete();
      }
      if (fireball.touching(ground)) {
        fireball.y += 5;
        fireball.speedY = -(fireball.speedY * 0.8);
      }
      obstacles.forEach(obstacle => {
        if (fireball.touching(obstacle)) {
          if (fireball.y > obstacle.top) {
            fireball.y += 5;
            fireball.speedY = -(fireball.speedY * 0.8);
          }
          else if (fireball.y < obstacle.bottom) {
            fireball.y -= 5;
            fireball.speedY = -(fireball.speedY * 0.8);
          }
          else {
            fireball.speedX = -fireball.speedX; 
          }
        }
      });
      if (fireball.touching(boss)) {
        fireballs.remove(fireball);
        fireball.delete();
        boss.health -= 1;
        boss.brightness = 30;
        after(0.2, "second", () => {
          boss.brightness = 100;
        });
        if (boss.health <= 0) {
          boss.hide();
          bossHealth.hide();
          heartX = hearts[hearts.length -1].x + 30;
          while (hearts.length < 5) {
            hearts.push(new Image({
              url: "../images/platformer-heart.png",
              height: 30,
              width: 30,
              x: heartX,
              y: maxY - 30
            }));
            heartX += 30;
          }
          hearts.forEach(heart => {
            heart.hide();
            after(0.2, "second", () => {
              heart.show();
              after(0.2, "second", () => {
                heart.hide();
                after(0.2, "second", () => {
                  heart.show();
                });
              });
            });
          });
        }
      }
    });
  }
});

forever(() => {
  if (!gameOver) {
    enemies.forEach(enemy => {
      enemy.move(enemy.speedX);
      if (enemy.x < minX || enemy.x > maxX) {
        enemies.remove(enemy);
        enemy.delete();
      }
      obstacles.forEach(obstacle => {
        if (enemy.touching(obstacle)) {
          enemy.speedX = -enemy.speedX;
        }
      });
      fireballs.forEach(fireball => {
        if (fireball.touching(enemy)) {
          enemies.remove(enemy);
          enemy.delete();
        }
      });
      if (enemy.touching(player)) {
        enemies.remove(enemy);
        enemy.delete();
        removeHeart();
        if (hearts.length < 1)
          gameOver = true;
      }
    });
  }
});

var bossWait = false;
forever(() => {
  if (boss.showing && !gameOver) {
    boss.move(boss.speedX);
    if (boss.x < minX || boss.x > maxX)
      boss.speedX = -boss.speedX;
    if (boss.touching(player) && !bossWait) {
      bossWait = true;
      boss.speedX = -boss.speedX;
      boss.move(boss.speedX);
      removeHeart();
      if (hearts.length < 1)
        gameOver = true;
      after(1.5, "second", () => {
        bossWait = false;
      });
    }
  }
});

onKeyDown(() => {
  if (keysDown.includes("up") && player.touchingSurface() && !gameOver) {
    var jump = 20;
    var jumpChange = 1;
    repeat(15, () => {
      player.y += jump;
      jump -= jumpChange;
      obstacles.forEach(obstacle => {
        if (player.touching(obstacle) && player.y >= obstacle.bottom - 20) {
          player.y = obstacle.bottom - 21;
          jump = 0;
          jumpChange = 0;
        }
      });
    });
  }
  if (keysDown.includes("space") && !gameOver) {
    var fireball = new Circle({
      color: "#C72000",
      radius: 6,
      x: player.x,
      y: player.y + 5,
      angle: player.angle
    });
    fireball.speedX = 7;
    fireball.speedY = -0.35;
    fireball.move(10);
    fireballs.push(fireball);
  }
});

after(2, "second", () => {
  every(() => random(1.9, 5.1), "second", () => {
    if (!gameOver && !bossLevel) {
      var enemy = new Image({
        url: "../images/platformer-enemy.png",
        height: 35,
        width: 35,
        x: maxX,
        y: 18 + ground.y + ground.height / 2
      });
      enemy.speedX = -2;
      enemies.push(enemy);
      if (enemy.touching(player)) {
        enemies.remove(enemy);
        enemy.delete();
      }
    }
  });
});

</script>
</body>
</html>